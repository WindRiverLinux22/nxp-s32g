From 2687e123d91f8f362a83f371582ba3e30677b032 Mon Sep 17 00:00:00 2001
From: Bogdan Folea <bogdan.folea@nxp.com>
Date: Wed, 27 Oct 2021 11:46:52 +0300
Subject: [PATCH 3/3] crypto: hse: update firmware interface to v1.0.0

commit f2687e123d91f8f362a83f371582ba3e30677b032 from
https://source.codeaurora.org/external/autobsps32/linux

Issue: ALB-7687
Upstream-Status: Pending 

Signed-off-by: Bogdan Folea <bogdan.folea@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 drivers/crypto/hse/hse-core.c | 31 +++++++++++++++++++++++++------
 drivers/crypto/hse/hse-mu.h   |  2 +-
 2 files changed, 26 insertions(+), 7 deletions(-)

diff --git a/drivers/crypto/hse/hse-core.c b/drivers/crypto/hse/hse-core.c
index 6243cf63a73e..c6b6f69e6478 100644
--- a/drivers/crypto/hse/hse-core.c
+++ b/drivers/crypto/hse/hse-core.c
@@ -131,6 +131,29 @@ u32 _get_rng_srv_id(struct device *dev)
 	return drv->rng_srv_id;
 }
 
+/**
+ * hse_fw_if_fixup - interface fixup to ensure compatibility with older firmware
+ * @dev: HSE device
+ */
+static void hse_fw_if_fixup(struct device *dev)
+{
+	struct hse_drvdata *drv = dev_get_drvdata(dev);
+	u8 channel;
+
+	/* adjust number of streaming contexts for fw < v1.0.0 */
+	if (drv->firmware_version.major < 1u)
+		for (channel = 1; channel < HSE_NUM_CHANNELS; channel++)
+			if (channel < HSE_NUM_CHANNELS - 2u)
+				drv->type[channel] = HSE_CH_TYPE_SHARED;
+
+	/* adjust RNG service ID for fw < v0.9.2 */
+	drv->rng_srv_id = HSE_SRV_ID_GET_RANDOM_NUM;
+	if (drv->firmware_version.major == 0u &&
+	    drv->firmware_version.minor == 9u &&
+	    drv->firmware_version.patch < 2u)
+		drv->rng_srv_id |= 0x00A50000ul;
+}
+
 /**
  * hse_key_ring_init - initialize all keys in a specific key group
  * @dev: HSE device
@@ -835,12 +858,8 @@ static int hse_probe(struct platform_device *pdev)
 		 drv->firmware_version.fw_type, drv->firmware_version.major,
 		 drv->firmware_version.minor, drv->firmware_version.patch);
 
-	/* backwards compatibility with older firmware */
-	drv->rng_srv_id = HSE_SRV_ID_GET_RANDOM_NUM;
-	if (drv->firmware_version.major == 0u &&
-	    drv->firmware_version.minor == 9u &&
-	    drv->firmware_version.patch < 2u)
-		drv->rng_srv_id |= 0x00A50000ul;
+	/* interface fixup */
+	hse_fw_if_fixup(dev);
 
 	/* check HSE global status */
 	if (IS_ENABLED(CONFIG_CRYPTO_DEV_NXP_HSE_HWRNG) &&
diff --git a/drivers/crypto/hse/hse-mu.h b/drivers/crypto/hse/hse-mu.h
index 46191a6ca9db..c1770e0686be 100644
--- a/drivers/crypto/hse/hse-mu.h
+++ b/drivers/crypto/hse/hse-mu.h
@@ -14,7 +14,7 @@
 #define HSE_MU_INST    "mu" __stringify(CONFIG_CRYPTO_DEV_NXP_HSE_MU_ID) "b"
 
 #define HSE_NUM_CHANNELS    16u /* number of available service channels */
-#define HSE_STREAM_COUNT    2u /* number of usable streams per MU instance */
+#define HSE_STREAM_COUNT    4u /* number of usable streams per MU instance */
 
 #define HSE_CHANNEL_INV    0xFFu /* invalid acquired service channel index */
 #define HSE_CH_MASK_ALL    0x0000FFFFul /* all available channels irq mask */
-- 
2.17.1

