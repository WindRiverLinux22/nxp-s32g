From 33e90d18fc21cd383c96cdcc00c28f64d33ff4f4 Mon Sep 17 00:00:00 2001
From: Dan Nica <dan.nica@nxp.com>
Date: Mon, 13 Sep 2021 12:25:33 +0300
Subject: [PATCH 16/17] s32gen1: usdhc: Perform strobe DLL lock at 200 MHz

commit 33e90d18fc21cd383c96cdcc00c28f64d33ff4f4 from
https://source.codeaurora.org/external/autobsps32/linux

Upstream-Status: Pending

Issue: ALB-7257
Signed-off-by: Dan Nica <dan.nica@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 drivers/mmc/host/sdhci-esdhc-imx.c | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/drivers/mmc/host/sdhci-esdhc-imx.c b/drivers/mmc/host/sdhci-esdhc-imx.c
index 86d8cb4f55d1..ec2968b21177 100644
--- a/drivers/mmc/host/sdhci-esdhc-imx.c
+++ b/drivers/mmc/host/sdhci-esdhc-imx.c
@@ -1261,9 +1261,18 @@ static void esdhc_set_uhs_signaling(struct sdhci_host *host, unsigned timing)
 		break;
 	case MMC_TIMING_MMC_HS400:
 		m |= ESDHC_MIX_CTRL_DDREN | ESDHC_MIX_CTRL_HS400_EN;
+		if (imx_data->socdata == &usdhc_s32gen1_data &&
+			host->mmc->caps2 & MMC_CAP2_HS400_ES)
+			m |= ESDHC_MIX_CTRL_HS400_ES_EN;
 		writel(m, host->ioaddr + ESDHC_MIX_CTRL);
 		imx_data->is_ddr = 1;
 		/* update clock after enable DDR for strobe DLL lock */
+		if (imx_data->socdata == &usdhc_s32gen1_data)
+			/* The uSDHC controller on s32gen1 platforms requires
+			 * that the clock is above 133MHz when attempting the
+			 * strobe DLL lock
+			 */
+			host->clock = 200 * 1000 * 1000;
 		host->ops->set_clock(host, host->clock);
 		esdhc_set_strobe_dll(host);
 		break;
-- 
2.17.1

