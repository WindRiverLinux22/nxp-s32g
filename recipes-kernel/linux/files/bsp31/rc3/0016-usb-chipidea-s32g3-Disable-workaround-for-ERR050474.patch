From 31f0d9b4d7b2e0b5ca83d77ef55dd507ce4b02a7 Mon Sep 17 00:00:00 2001
From: Ghennadi Procopciuc <ghennadi.procopciuc@nxp.com>
Date: Fri, 24 Sep 2021 12:10:46 +0300
Subject: [PATCH 16/20] usb/chipidea: s32g3: Disable workaround for ERR050474

Issue: ALB-7732
Upstream-Status: Pending 

Signed-off-by: Ghennadi Procopciuc <ghennadi.procopciuc@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 drivers/usb/chipidea/usbmisc_imx.c | 39 ++++++++++++++++++++++++------
 1 file changed, 32 insertions(+), 7 deletions(-)

diff --git a/drivers/usb/chipidea/usbmisc_imx.c b/drivers/usb/chipidea/usbmisc_imx.c
index 6212dbb1bba2..9de8ce85ff8b 100644
--- a/drivers/usb/chipidea/usbmisc_imx.c
+++ b/drivers/usb/chipidea/usbmisc_imx.c
@@ -631,7 +631,7 @@ static int usbmisc_s32g_set_wakeup
 	return 0;
 }
 
-static int usbmisc_s32g_init(struct imx_usbmisc_data *data)
+static int usbmisc_s32g_init(struct imx_usbmisc_data *data, bool en_all_byte)
 {
 	struct imx_usbmisc *usbmisc = dev_get_drvdata(data->dev);
 	unsigned long flags;
@@ -640,7 +640,12 @@ static int usbmisc_s32g_init(struct imx_usbmisc_data *data)
 	spin_lock_irqsave(&usbmisc->lock, flags);
 
 	reg = readl(usbmisc->base);
-	writel(reg | S32G_PWRFLTEN | S32G_UCMALLBE, usbmisc->base);
+
+	reg |= S32G_PWRFLTEN;
+	if (en_all_byte)
+		reg |= S32G_UCMALLBE;
+
+	writel(reg, usbmisc->base);
 
 	spin_unlock_irqrestore(&usbmisc->lock, flags);
 	usbmisc_s32g_set_wakeup(data, false);
@@ -648,6 +653,17 @@ static int usbmisc_s32g_init(struct imx_usbmisc_data *data)
 	return 0;
 }
 
+static int usbmisc_s32g2_init(struct imx_usbmisc_data *data)
+{
+	/* Enable workaround for ERR050474 */
+	return usbmisc_s32g_init(data, true);
+}
+
+static int usbmisc_s32g3_init(struct imx_usbmisc_data *data)
+{
+	return usbmisc_s32g_init(data, false);
+}
+
 static int usbmisc_imx7d_set_wakeup
 	(struct imx_usbmisc_data *data, bool enabled)
 {
@@ -1029,8 +1045,14 @@ static const struct usbmisc_ops imx7ulp_usbmisc_ops = {
 	.hsic_set_clk = usbmisc_imx6_hsic_set_clk,
 };
 
-static const struct usbmisc_ops s32g_usbmisc_ops = {
-	.init = usbmisc_s32g_init,
+static const struct usbmisc_ops s32g2_usbmisc_ops = {
+	.init = usbmisc_s32g2_init,
+	.set_wakeup = usbmisc_s32g_set_wakeup,
+	.flags = REINIT_DURING_RESUME,
+};
+
+static const struct usbmisc_ops s32g3_usbmisc_ops = {
+	.init = usbmisc_s32g3_init,
 	.set_wakeup = usbmisc_s32g_set_wakeup,
 	.flags = REINIT_DURING_RESUME,
 };
@@ -1239,10 +1261,13 @@ static const struct of_device_id usbmisc_imx_dt_ids[] = {
 		.data = &imx7ulp_usbmisc_ops,
 	},
 	{
-		.compatible = "fsl,s32g-usbmisc",
-		.data = &s32g_usbmisc_ops,
+		.compatible = "fsl,s32g2-usbmisc",
+		.data = &s32g2_usbmisc_ops,
+	},
+	{
+		.compatible = "fsl,s32g3-usbmisc",
+		.data = &s32g3_usbmisc_ops,
 	},
-
 	{ /* sentinel */ }
 };
 MODULE_DEVICE_TABLE(of, usbmisc_imx_dt_ids);
-- 
2.17.1

