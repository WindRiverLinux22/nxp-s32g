From 4b49423fdbdf9523b9ad8d241d2837862e2e4e70 Mon Sep 17 00:00:00 2001
From: Ionut Vicovan <Ionut.Vicovan@nxp.com>
Date: Tue, 9 Aug 2022 23:20:05 +0300
Subject: [PATCH 094/102] s32cc:pcie: Remove some duplicate code and regroup
 some Gen3 settings

Issue: ALB-9065

Upstream-Status: Pending 

Signed-off-by: Ionut Vicovan <Ionut.Vicovan@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 drivers/pci/pcie_s32gen1.c | 45 ++++++++++++++------------------------
 1 file changed, 17 insertions(+), 28 deletions(-)

diff --git a/drivers/pci/pcie_s32gen1.c b/drivers/pci/pcie_s32gen1.c
index 1db0ac0d48..269ae9eec3 100644
--- a/drivers/pci/pcie_s32gen1.c
+++ b/drivers/pci/pcie_s32gen1.c
@@ -694,24 +694,11 @@ static bool s32_pcie_init(void __iomem *dbi, int id, bool rc_mode,
 		W32(UPTR(dbi) + SS_PE0_GEN_CTRL_1,
 		    BUILD_MASK_VALUE(DEVICE_TYPE, PCIE_EP));
 
-	if (phy_mode == SRIS)
+	if (phy_mode == SRIS) {
 		BSET32(UPTR(dbi) + SS_PE0_GEN_CTRL_1, PCIE_SRIS_MODE_MASK);
-
-	/* Enable writing dbi registers */
-	s32_pcie_enable_dbi_rw(dbi);
-
-	/* Enable direct speed change */
-	BSET32(UPTR(dbi) + PCIE_PORT_LOGIC_GEN2_CTRL,
-	       PCIE_DIRECT_SPEED_CHANGE);
-
-	/* Disable phase 2,3 equalization */
-	RMW32(UPTR(dbi) + PCIE_PORT_LOGIC_GEN3_EQ_CONTROL,
-	      BUILD_MASK_VALUE(PCIE_GEN3_EQ_FB_MODE, 1) |
-	      BUILD_MASK_VALUE(PCIE_GEN3_EQ_PSET_REQ_VEC, 0x84),
-	      PCIE_GEN3_EQ_FB_MODE | PCIE_GEN3_EQ_PSET_REQ_VEC);
-	/* Test value */
-	debug("PCIE_PORT_LOGIC_GEN3_EQ_CONTROL: 0x%08x\n",
-	      s32_dbi_readl(UPTR(dbi) + PCIE_PORT_LOGIC_GEN3_EQ_CONTROL));
+		BSET32(UPTR(dbi) + PCIE_PORT_LOGIC_PORT_FORCE,
+		       PCIE_DO_DESKEW_FOR_SRIS);
+	}
 
 	if (!s32_pcie_set_max_link_width(dbi, id, linkwidth))
 		return false;
@@ -726,8 +713,6 @@ static bool s32_pcie_init(void __iomem *dbi, int id, bool rc_mode,
 	 * change those defaults.
 	 */
 
-	BSET32(UPTR(dbi) + PCIE_PORT_LOGIC_PORT_FORCE, PCIE_DO_DESKEW_FOR_SRIS);
-
 	if (rc_mode) {
 		/* Set max payload supported, 256 bytes and
 		 * relaxed ordering.
@@ -771,16 +756,20 @@ static bool s32_pcie_init(void __iomem *dbi, int id, bool rc_mode,
 	BSET32(UPTR(dbi) + PCIE_PORT_LOGIC_GEN2_CTRL,
 	       PCIE_DIRECT_SPEED_CHANGE);
 
-	/* Disable phase 2,3 equalization */
-	RMW32(UPTR(dbi) + PCIE_PORT_LOGIC_GEN3_EQ_CONTROL,
-	      BUILD_MASK_VALUE(PCIE_GEN3_EQ_FB_MODE, 1) |
-	      BUILD_MASK_VALUE(PCIE_GEN3_EQ_PSET_REQ_VEC, 0x84),
-	      PCIE_GEN3_EQ_FB_MODE | PCIE_GEN3_EQ_PSET_REQ_VEC);
-	/* Test value */
-	debug("PCIE_PORT_LOGIC_GEN3_EQ_CONTROL: 0x%08x\n",
-	      s32_dbi_readl(UPTR(dbi) + PCIE_PORT_LOGIC_GEN3_EQ_CONTROL));
+	if (linkspeed == GEN3) {
+		/* Disable phase 2,3 equalization */
+		RMW32(UPTR(dbi) + PCIE_PORT_LOGIC_GEN3_EQ_CONTROL,
+		      BUILD_MASK_VALUE(PCIE_GEN3_EQ_FB_MODE, 1) |
+		      BUILD_MASK_VALUE(PCIE_GEN3_EQ_PSET_REQ_VEC, 0x84),
+		      PCIE_GEN3_EQ_FB_MODE | PCIE_GEN3_EQ_PSET_REQ_VEC);
+		/* Test value */
+		debug("PCIE_PORT_LOGIC_GEN3_EQ_CONTROL: 0x%08x\n",
+		      s32_dbi_readl(UPTR(dbi) +
+				    PCIE_PORT_LOGIC_GEN3_EQ_CONTROL));
 
-	BSET32(UPTR(dbi) + PCIE_PORT_LOGIC_GEN3_RELATED, PCIE_EQ_PHASE_2_3);
+		BSET32(UPTR(dbi) + PCIE_PORT_LOGIC_GEN3_RELATED,
+		       PCIE_EQ_PHASE_2_3);
+	}
 
 	/* Disable writing dbi registers */
 	s32_pcie_disable_dbi_rw(dbi);
-- 
2.17.1

