From ec7e2b5f32c2e73c55a7cff6bfc6b1c65bd91009 Mon Sep 17 00:00:00 2001
From: Ghennadi Procopciuc <ghennadi.procopciuc@nxp.com>
Date: Thu, 21 Jul 2022 10:26:50 +0300
Subject: [PATCH 042/102] pci: s32cc: Make SerDes mode validation part of
 platform checks

Issue: ALB-8357
Upstream-Status: Pending 

Signed-off-by: Ghennadi Procopciuc <ghennadi.procopciuc@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 arch/arm/mach-s32/s32-cc/serdes_hwconfig.c | 5 +++++
 drivers/pci/serdes_s32gen1.c               | 4 ----
 2 files changed, 5 insertions(+), 4 deletions(-)

diff --git a/arch/arm/mach-s32/s32-cc/serdes_hwconfig.c b/arch/arm/mach-s32/s32-cc/serdes_hwconfig.c
index 805cd7478c..aef81a6279 100644
--- a/arch/arm/mach-s32/s32-cc/serdes_hwconfig.c
+++ b/arch/arm/mach-s32/s32-cc/serdes_hwconfig.c
@@ -250,6 +250,11 @@ bool s32_serdes_is_cfg_valid(int id)
 	mode = s32_serdes_get_op_mode_from_hwconfig(id);
 	phy_mode = s32_serdes_get_phy_mode_from_hwconfig(id);
 
+	if (mode == SERDES_MODE_INVAL) {
+		printf("Invalid opmode config on SerDes%d\n", id);
+		return false;
+	}
+
 	if (devtype == SERDES_INVALID) {
 		printf("Invalid SerDes%d configuration\n", id);
 		return false;
diff --git a/drivers/pci/serdes_s32gen1.c b/drivers/pci/serdes_s32gen1.c
index 034b2e965a..2263857f2b 100644
--- a/drivers/pci/serdes_s32gen1.c
+++ b/drivers/pci/serdes_s32gen1.c
@@ -346,10 +346,6 @@ static bool s32_serdes_init(struct serdes *serdes)
 	int ret;
 
 	serdes->ss_mode = s32_serdes_get_op_mode_from_hwconfig(serdes->id);
-	if (serdes->ss_mode == SERDES_MODE_INVAL) {
-		printf("ERROR: Invalid opmode config on PCIe%d\n",  serdes->id);
-		return false;
-	}
 
 	/* Reset the Serdes module */
 	ret = s32_serdes_assert_reset(serdes);
-- 
2.17.1

