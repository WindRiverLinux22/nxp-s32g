From 9c0b9b41321c94682a587f9faa39ef44979e01ee Mon Sep 17 00:00:00 2001
From: Ionut Vicovan <Ionut.Vicovan@nxp.com>
Date: Thu, 10 Nov 2022 01:14:50 +0200
Subject: [PATCH 19/19] s32:serdes:hwconfig: Update Kconfigs for the new format

Issue: ALB-8798

Upstream-Status: Pending 

Signed-off-by: Ionut Vicovan <Ionut.Vicovan@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 arch/arm/mach-s32/s32-cc/Kconfig   | 45 +++++++++++++++++++++++-------
 arch/arm/mach-s32/s32g3/Kconfig    |  3 ++
 board/nxp/s32-cc/s32g/Kconfig      |  3 --
 board/nxp/s32g274abluebox3/Kconfig |  2 +-
 include/configs/s32-cc.h           |  4 +--
 5 files changed, 41 insertions(+), 16 deletions(-)

diff --git a/arch/arm/mach-s32/s32-cc/Kconfig b/arch/arm/mach-s32/s32-cc/Kconfig
index dee68986a6..0b2d68f3a0 100644
--- a/arch/arm/mach-s32/s32-cc/Kconfig
+++ b/arch/arm/mach-s32/s32-cc/Kconfig
@@ -55,20 +55,42 @@ config SYS_MEM_SIZE
 	help
 	  U-boot SRAM size (8 MB for Gen1)
 
-config S32GEN1_HWCONFIG
-	string "S32GEN1 HWConfig definition"
+config S32CC_HWCONFIG
+	string "S32CC HWConfig definition"
 	depends on NXP_S32CC && (PCIE_S32GEN1 || FSL_PFENG)
-	default "pcie0:mode=sgmii;pcie1:mode=sgmii" if (!PCIE_S32GEN1 && FSL_PFENG)
-	default "pcie0:mode=rc,clock=ext;pcie1:mode=ep,clock=int" if (PCIE_S32GEN1 && !FSL_PFENG)
+	default "serdes0:mode=xpcs0&xpcs1,clock=ext,fmhz=125;xpcs0_0:speed=2G5;xpcs0_1:speed=2G5;serdes1:mode=xpcs0&xpcs1,clock=ext,fmhz=125;xpcs1_0:speed=2G5;xpcs1_1:speed=2G5" if (!PCIE_S32GEN1 && FSL_PFENG)
+	default "serdes0:mode=pcie,clock=ext;pcie0:mode=rc;serdes1:mode=pcie,clock=int;pcie1:mode=ep" if (PCIE_S32GEN1 && !FSL_PFENG)
+	default "serdes0:mode=pcie,clock=ext;pcie0:mode=rc;serdes1:mode=xpcs0&xpcs1,clock=ext,fmhz=125;xpcs1_0:speed=2G5" if (PCIE_S32GEN1 && FSL_PFENG)
+
 	help
 	  The configuration for the PCIe controllers, stored in
-	  the variable 'hwconfig'
-	  It configures the mode (rc, ep, sgmii) or the clock type
-	  (internal or external)
-	  It is also possible to configure combo mode either ep&sgmii or
-	  rc&sgmii, with these configurations lane0 is PCIe and lane1
-	  is connected to mac depending on 'xpcs_mode'.
+	  the variable 'hwconfig'.
+	  It configures 'serdesX' generic attributes, such as 'mode' ('pcie',
+	  'pcie&xpcs0', 'pcie&xpcs1', 'xpcs0&xpcs1'), the clock type
+	  (internal or external), clock frequency 'fmhz', 'pcieX' mode (rc or ep)
+	  and the 'xpcsX_Y' interface for any of the two lanes.
+	  For the combo modes 'pcie&xpcs0' or 'pcie&xpcs1', lane0 is PCIe and lane1
+	  is connected to a GMAC or PFE MAC depending on 'xpcsX_Y' configuration.
 	  SGMII uses additional configurations 'fmhz' and 'xpcs_mode'.
+	  Config 'xpcsX_Y' is used to specifically configure each of the two SGMII
+	  PHYs, by setting the 'speed' (10M, 100M, 1G and 2G5).
+	  S32G2 and S32G3 have 1 GMAC running at 1Gbps and 3 PFE MACs, running at
+		10Mbps - 2.5Gbps speeds.
+	  S32R45 has one GMAC running at 1Gbps or 2.5Gbps
+
+config S32CC_HWCONFIG_LEGACY
+	bool "Legacy S32CC HWConfig definition"
+	default y
+	depends on NXP_S32CC && (PCIE_S32GEN1 || FSL_PFENG)
+	help
+	  Support for old format for variable HWCONFIG. Each SerDes
+	  is identified by the string 'pcieX' and is configured by a list of
+	  attributes such as 'mode' (rc, ep, sgmii) and the clock type
+	  (internal or external).
+	  It is also possible to configure combo modes, either 'ep&sgmii' or
+	  'rc&sgmii', with these configurations lane0 is PCIe and lane1
+	  is connected to GMAC of PFE mac depending on 'xpcs_mode'.
+	  'sgmii' mode uses additional config options 'fmhz' and 'xpcs_mode'.
 	  Config 'xpcs_mode' is used to specifically configure each line in
 	  SGMII mode. The following are valid options: '2G5', 'both', '0' and
 	  '1'. Mode '2G5' uses lane0 in 2.5G mode and leaves lane1 disabled.
@@ -85,6 +107,9 @@ config S32GEN1_HWCONFIG
 	  Available 'xpcs_mode' are depedent on platform:
 	  	s32g274a - supports '0','1','both' and '2G5'
 	  	s32r45   - supports '0' and '2G5'
+	  By default, legacy HWCONFIG was:
+	  "pcie0:mode=rc,clock=ext;pcie1:mode=sgmii,clock=ext,fmhz=125,xpcs_mode=2G5"
+	  This has lots of limitations, and has been redesigned.
 
 config S32CC_CONFIG_FILE
 	string
diff --git a/arch/arm/mach-s32/s32g3/Kconfig b/arch/arm/mach-s32/s32g3/Kconfig
index fc0b6f2c5c..82f575985a 100644
--- a/arch/arm/mach-s32/s32g3/Kconfig
+++ b/arch/arm/mach-s32/s32g3/Kconfig
@@ -43,6 +43,9 @@ endchoice
 config FSL_PFENG
 	default y if !TARGET_TYPE_S32GEN1_EMULATOR
 
+config S32CC_HWCONFIG
+	default "serdes0:mode=pcie,clock=ext;pcie0:mode=rc;serdes1:mode=xpcs0&xpcs1,clock=ext,fmhz=125;xpcs1_0:speed=2G5;xpcs1_1:speed=2G5" if (PCIE_S32GEN1 && FSL_PFENG)
+
 source "board/nxp/s32-cc/s32g/Kconfig"
 source "board/nxp/s32g399ardb3/Kconfig"
 source "board/nxp/s32g3xxaevb/Kconfig"
diff --git a/board/nxp/s32-cc/s32g/Kconfig b/board/nxp/s32-cc/s32g/Kconfig
index 7cc79d5d88..c6874807ad 100644
--- a/board/nxp/s32-cc/s32g/Kconfig
+++ b/board/nxp/s32-cc/s32g/Kconfig
@@ -40,6 +40,3 @@ config NXP_S32GEVB_BOARD
 	imply SJA1105
 	select MISC_INIT_R if SJA1105
 	select SPI_FLASH_MACRONIX
-
-config S32GEN1_HWCONFIG
-	default "pcie0:mode=rc,clock=ext;pcie1:mode=sgmii,clock=ext,fmhz=125,xpcs_mode=2G5"
diff --git a/board/nxp/s32g274abluebox3/Kconfig b/board/nxp/s32g274abluebox3/Kconfig
index 0b62ef5d63..1dfa07d176 100644
--- a/board/nxp/s32g274abluebox3/Kconfig
+++ b/board/nxp/s32g274abluebox3/Kconfig
@@ -12,7 +12,7 @@ config SYS_BOARD
 config NR_DRAM_BANKS
 	default 2
 
-config S32GEN1_HWCONFIG
+config S32CC_HWCONFIG
 	default "pcie0:mode=ep,clock=ext;pcie1:mode=sgmii,clock=ext,fmhz=125,xpcs_mode=0" if (PCIE_S32GEN1 && FSL_PFENG)
 
 config ENV_SECT_SIZE
diff --git a/include/configs/s32-cc.h b/include/configs/s32-cc.h
index 5b5014a5a2..ce730b1ce8 100644
--- a/include/configs/s32-cc.h
+++ b/include/configs/s32-cc.h
@@ -105,8 +105,8 @@
 #  define GMAC_EXTRA_ENV_SETTINGS	""
 #endif
 
-#if defined(CONFIG_S32GEN1_HWCONFIG)
-#  define PCIE_EXTRA_ENV_SETTINGS "hwconfig=" CONFIG_S32GEN1_HWCONFIG "\0"
+#if defined(CONFIG_S32CC_HWCONFIG)
+#  define PCIE_EXTRA_ENV_SETTINGS "hwconfig=" CONFIG_S32CC_HWCONFIG "\0"
 #else
 #  define PCIE_EXTRA_ENV_SETTINGS ""
 #endif
-- 
2.17.1

