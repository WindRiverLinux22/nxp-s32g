From defd96bbdf3702974e8dcc4939973f3ae82390ec Mon Sep 17 00:00:00 2001
From: Andra-Teodora Ilie <andra.ilie@nxp.com>
Date: Fri, 22 Jul 2022 17:35:32 +0300
Subject: [PATCH 48/49] plat: s32: enable performance domain protocol for s32
 platforms

Issue: ALB-7158
Upstream-Status: Pending 

Signed-off-by: Andra-Teodora Ilie <andra.ilie@nxp.com>
Signed-off-by: Zhantao Tang <zhantao.tang@windriver.com>
---
 fdts/s32cc.dtsi            | 10 ++++++++++
 fdts/s32g3.dtsi            |  4 ++++
 plat/nxp/s32/s32_common.mk |  2 ++
 plat/nxp/s32/s32_svc.c     |  1 +
 4 files changed, 17 insertions(+)

diff --git a/fdts/s32cc.dtsi b/fdts/s32cc.dtsi
index 8bc16526d..d7029dc20 100644
--- a/fdts/s32cc.dtsi
+++ b/fdts/s32cc.dtsi
@@ -8,6 +8,7 @@
 #include <dt-bindings/clock/s32gen1-clock-freq.h>
 #include <dt-bindings/clock/s32gen1-clock.h>
 #include <dt-bindings/clock/s32gen1-scmi-clock.h>
+#include <dt-bindings/perf/s32gen1-scmi-perf.h>
 #include <dt-bindings/interrupt-controller/arm-gic.h>
 #include <dt-bindings/phy/phy.h>
 #include <dt-bindings/reset/s32gen1-scmi-reset.h>
@@ -81,6 +82,11 @@
 			#size-cells = <0>;
 			status = "okay";
 
+			dfs: protocol@13 {
+				reg = <0x13>;
+				#clock-cells = <1>;
+			};
+
 			clks: protocol@14 {
 				u-boot,dm-pre-reloc;
 
@@ -132,6 +138,7 @@
 			compatible = "arm,cortex-a53";
 			reg = <0x0>;
 			enable-method = "psci";
+			clocks = <&dfs S32GEN1_SCMI_PERF_A53>;
 			next-level-cache = <&cluster0_l2_cache>;
 
 			nvmem-cells = <&soc_letter>, <&part_no>,
@@ -146,6 +153,7 @@
 			compatible = "arm,cortex-a53";
 			reg = <0x1>;
 			enable-method = "psci";
+			clocks = <&dfs S32GEN1_SCMI_PERF_A53>;
 			next-level-cache = <&cluster0_l2_cache>;
 
 			nvmem-cells = <&soc_letter>, <&part_no>,
@@ -159,6 +167,7 @@
 			compatible = "arm,cortex-a53";
 			reg = <0x100>;
 			enable-method = "psci";
+			clocks = <&dfs S32GEN1_SCMI_PERF_A53>;
 			next-level-cache = <&cluster1_l2_cache>;
 
 			nvmem-cells = <&soc_letter>, <&part_no>,
@@ -172,6 +181,7 @@
 			compatible = "arm,cortex-a53";
 			reg = <0x101>;
 			enable-method = "psci";
+			clocks = <&dfs S32GEN1_SCMI_PERF_A53>;
 			next-level-cache = <&cluster1_l2_cache>;
 
 			nvmem-cells = <&soc_letter>, <&part_no>,
diff --git a/fdts/s32g3.dtsi b/fdts/s32g3.dtsi
index fc45e7ee3..f014937a6 100644
--- a/fdts/s32g3.dtsi
+++ b/fdts/s32g3.dtsi
@@ -47,6 +47,7 @@
 			compatible = "arm,cortex-a53";
 			reg = <0x2>;
 			enable-method = "psci";
+			clocks = <&dfs S32GEN1_SCMI_PERF_A53>;
 			next-level-cache = <&cluster0_l2_cache>;
 
 			nvmem-cells = <&soc_letter>, <&part_no>,
@@ -60,6 +61,7 @@
 			compatible = "arm,cortex-a53";
 			reg = <0x3>;
 			enable-method = "psci";
+			clocks = <&dfs S32GEN1_SCMI_PERF_A53>;
 			next-level-cache = <&cluster0_l2_cache>;
 
 			nvmem-cells = <&soc_letter>, <&part_no>,
@@ -73,6 +75,7 @@
 			compatible = "arm,cortex-a53";
 			reg = <0x102>;
 			enable-method = "psci";
+			clocks = <&dfs S32GEN1_SCMI_PERF_A53>;
 			next-level-cache = <&cluster1_l2_cache>;
 
 			nvmem-cells = <&soc_letter>, <&part_no>,
@@ -86,6 +89,7 @@
 			compatible = "arm,cortex-a53";
 			reg = <0x103>;
 			enable-method = "psci";
+			clocks = <&dfs S32GEN1_SCMI_PERF_A53>;
 			next-level-cache = <&cluster1_l2_cache>;
 
 			nvmem-cells = <&soc_letter>, <&part_no>,
diff --git a/plat/nxp/s32/s32_common.mk b/plat/nxp/s32/s32_common.mk
index 6ec40efa5..85adb051f 100644
--- a/plat/nxp/s32/s32_common.mk
+++ b/plat/nxp/s32/s32_common.mk
@@ -110,12 +110,14 @@ BL31_SOURCES += \
 			${S32_DRIVERS}/clk/fixed_clk.c \
 			${S32_DRIVERS}/clk/s32gen1_scmi_clk.c \
 			${S32_DRIVERS}/clk/s32gen1_scmi_ids.c \
+			${S32_DRIVERS}/perf/s32gen1_scmi_perf.c \
 			plat/common/plat_gicv3.c \
 			plat/common/plat_psci_common.c \
 			${S32_PLAT}/include/plat_macros.S \
 			${S32_PLAT}/s32_bl31.c \
 			${S32_PLAT}/s32_lowlevel_bl31.S \
 			${S32_PLAT}/s32_scmi_clk.c \
+			${S32_PLAT}/s32_scmi_perf.c \
 			${S32_PLAT}/s32_scmi_rst.c \
 			${S32_PLAT}/s32_svc.c \
 			${S32_PLAT}/s32_psci.c \
diff --git a/plat/nxp/s32/s32_svc.c b/plat/nxp/s32/s32_svc.c
index 57a8e1168..937f93b89 100644
--- a/plat/nxp/s32/s32_svc.c
+++ b/plat/nxp/s32/s32_svc.c
@@ -39,6 +39,7 @@ struct response {
 static const uint8_t s32_protocols[] = {
 	SCMI_PROTOCOL_ID_BASE,
 	SCMI_PROTOCOL_ID_CLOCK,
+	SCMI_PROTOCOL_ID_PERF,
 	SCMI_PROTOCOL_ID_RESET_DOMAIN,
 };
 
-- 
2.25.1

